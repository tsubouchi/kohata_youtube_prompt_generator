<script>
  // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°é–¢æ•°
  function logDebug(message, data) {
    try {
      console.log('[DEBUG] ' + message, data || '');
    } catch (e) {
      // ãƒ­ã‚°å‡ºåŠ›ã«å¤±æ•—ã—ãŸå ´åˆã¯ç„¡è¦–
    }
  }

  // DOMè¦ç´ 
  const youtubeUrlInput = document.getElementById('youtubeUrl');
  const processButton = document.getElementById('processButton');
  const loadingSpinner = document.getElementById('loading');
  const resultSection = document.getElementById('resultSection');
  const errorSection = document.getElementById('errorSection');
  const errorMessage = document.getElementById('errorMessage');
  const tryAgainButton = document.getElementById('tryAgainButton');
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  const videoTitle = document.getElementById('videoTitle');
  const channelTitle = document.getElementById('channelTitle');
  const screenshotImage = document.getElementById('screenshotImage');
  const driveLink = document.getElementById('driveLink');
  const fullPrompt = document.getElementById('fullPrompt');
  const mainPrompt = document.getElementById('mainPrompt');
  const stylePrompt = document.getElementById('stylePrompt');
  const copyPromptButton = document.getElementById('copyPrompt');
  const copyIcon = document.getElementById('copyIcon');
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  document.addEventListener('DOMContentLoaded', function() {
    logDebug('DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«');
    
    // å‡¦ç†ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    processButton.addEventListener('click', processYouTubeUrl);
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        logDebug('ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ', tabId);
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã‚’æ›´æ–°
        tabButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º/éè¡¨ç¤º
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === tabId + 'Tab') {
            content.classList.add('active');
          }
        });
      });
    });
    
    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
    copyPromptButton.addEventListener('click', function() {
      logDebug('ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      const promptText = fullPrompt.textContent;
      navigator.clipboard.writeText(promptText).then(function() {
        // ã‚³ãƒ”ãƒ¼æˆåŠŸæ™‚ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        copyIcon.textContent = 'âœ“';
        setTimeout(() => {
          copyIcon.textContent = 'ğŸ“‹';
        }, 2000);
      }).catch(function(err) {
        logDebug('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
      });
    });
    
    // å†è©¦è¡Œãƒœã‚¿ãƒ³
    tryAgainButton.addEventListener('click', function() {
      errorSection.classList.add('hidden');
      youtubeUrlInput.value = '';
      youtubeUrlInput.focus();
    });
  });
  
  // YouTube URLã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
  function processYouTubeUrl() {
    const youtubeUrl = youtubeUrlInput.value.trim();
    logDebug('å‡¦ç†é–‹å§‹: YouTube URL', youtubeUrl);
    
    // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
    if (!youtubeUrl) {
      showError('YouTube URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    // YouTube URLã®ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})(.*)$/;
    if (!youtubeRegex.test(youtubeUrl)) {
      showError('æœ‰åŠ¹ãªYouTube URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    // UIçŠ¶æ…‹ã®æ›´æ–°
    showLoading();
    
    // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•°ã‚’å‘¼ã³å‡ºã—
    logDebug('ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™');
    google.script.run
      .withSuccessHandler(handleSuccess)
      .withFailureHandler(handleError)
      .processYouTubeUrl(youtubeUrl);
  }
  
  // æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  function handleSuccess(result) {
    logDebug('ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†æˆåŠŸ', result);
    hideLoading();
    
    // çµæœã‚’è¡¨ç¤º
    videoTitle.textContent = result.videoTitle || 'Untitled Video';
    channelTitle.textContent = result.channelTitle || '';
    
    // ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã‚’è¡¨ç¤º
    if (result.fileId) {
      // Google Driveã®ç”»åƒè¡¨ç¤ºURL
      const imageUrl = `https://drive.google.com/uc?export=view&id=${result.fileId}`;
      logDebug('ç”»åƒURL', imageUrl);
      screenshotImage.src = imageUrl;
      
      // Driveè¡¨ç¤ºãƒªãƒ³ã‚¯
      driveLink.href = `https://drive.google.com/file/d/${result.fileId}/view`;
    }
    
    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤º
    if (result.prompt) {
      fullPrompt.textContent = result.prompt;
      
      // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¸»è¦éƒ¨åˆ†ã¨ã‚¹ã‚¿ã‚¤ãƒ«éƒ¨åˆ†ã«åˆ†å‰²ï¼ˆç°¡æ˜“çš„ãªå®Ÿè£…ï¼‰
      const promptParts = result.prompt.split(',');
      const mainPart = promptParts.slice(0, Math.ceil(promptParts.length / 2)).join(',');
      const stylePart = promptParts.slice(Math.ceil(promptParts.length / 2)).join(',');
      
      mainPrompt.textContent = mainPart;
      stylePrompt.textContent = stylePart;
    }
    
    // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    resultSection.classList.remove('hidden');
  }
  
  // ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
  function handleError(error) {
    logDebug('ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼', error);
    hideLoading();
    showError(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
  }
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  function showLoading() {
    loadingSpinner.classList.remove('hidden');
    resultSection.classList.add('hidden');
    errorSection.classList.add('hidden');
    processButton.disabled = true;
  }
  
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
  function hideLoading() {
    loadingSpinner.classList.add('hidden');
    processButton.disabled = false;
  }
  
  // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
  function showError(message) {
    errorMessage.textContent = message;
    errorSection.classList.remove('hidden');
    resultSection.classList.add('hidden');
  }

  function generatePromptWithGemini(fileId) {
    // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
    
    try {
      // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
      var response = UrlFetchApp.fetch(endpoint, options);
      var responseText = response.getContentText();
      Logger.log("Gemini API Response: " + responseText); // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å…¨æ–‡ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
      
      var responseData = JSON.parse(responseText);
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ§‹é€ ã‚’è©³ç´°ã«ãƒ­ã‚°ã«è¨˜éŒ²
      Logger.log("Response structure: " + JSON.stringify(Object.keys(responseData)));
      if (responseData.candidates) {
        Logger.log("Candidates length: " + responseData.candidates.length);
        if (responseData.candidates.length > 0) {
          Logger.log("First candidate structure: " + JSON.stringify(Object.keys(responseData.candidates[0])));
        }
      }
      
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æŠ½å‡º
      if (responseData && responseData.candidates && responseData.candidates.length > 0) {
        var content = responseData.candidates[0].content;
        if (content && content.parts && content.parts.length > 0) {
          return content.parts[0].text;
        }
      }
      
      // ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯äºˆæœŸã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®å ´åˆ
      Logger.log("Unexpected response format: " + JSON.stringify(responseData));
      return "APIã‹ã‚‰ã®å¿œç­”ã‚’è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
    } catch (error) {
      Logger.log("Error calling Gemini API: " + error);
      return "Gemini APIã®å‘¼ã³å‡ºã—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.toString();
    }
  }
</script> 